params {
    input_image = '../multifish-testdata/LHA3_R3_small/stitching/export.n5'
    input_image_dataset = 'c1/s5'
    output_image_dir = '../multifish-testdata/LHA3_R3_small/segmentation'
    output_image_name = 'seg.tif'
    dask_work_dir = 'output/dask'
    output_blocksize = '128,128,128'
    distributed = true
    model = 'cyto'
    diameter = 8
    blocks_overlap = '4,4,4'
    cellprob_threshold = 1.0
    cellpose_eval_channels = '0,0'
    dask_config = '/Users/goinac/Work/HHMI/multifish/nfcore-multifish/tests/modules/local/distributedcellpose/dask_config.yml'
    max_cellpose_tasks = 4
    cellpose_workers = 2
    cellpose_required_workers = 1
    cellpose_worker_cpus = 2
    cellpose_worker_mem_gb = 6
    cellpose_driver_cpus = 4
    cellpose_driver_mem_gb = 12
    min_size = 10
    iou_depth = 1
    iou_threshold = 0.5
    device = '0'
    use_gpu = true
    use_net_avg = false
}

process {
    publishDir = { "${params.outdir}/${task.process.tokenize(':')[-1].tokenize('_')[0].toLowerCase()}" }

    ext.container = 'docker.io/multifish/distributed-cellpose:2.2.3'

    withName:DASK_STARTMANAGER {
        containerOptions = '-p 8787:8787 -p 8786:8786'
    }

    withName:DISTRIBUTEDCELLPOSE {
        ext {
            args = [
                "--output-blocksize ${params.output_blocksize}",
                "--dask-config ${params.dask_config}",
                "--model ${params.model}",
                "--cellprob_threshold ${params.cellprob_threshold}",
                "--diam_mean ${params.diameter}",
                "--blocks-overlaps ${params.blocks_overlap}",
                "--eval-channels ${params.cellpose_eval_channels}",
                "--max-cellpose-tasks ${params.max_cellpose_tasks}",
                "--min_size ${params.min_size}",
                "--device ${params.device}",
                "--iou-threshold ${params.iou_threshold}",
                "${params.use_gpu ? '--use_gpu' : ''}",
                "${params.use_net_avg ? '--net_avg' : ''}",
            ].join(' ')
        }
    }
}
