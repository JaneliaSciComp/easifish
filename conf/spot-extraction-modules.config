params {
    runtime_opts                      = ''

    spot_extraction_ids               = ''

    skip_spot_extraction              = false
    distributed_spot_extraction       = true
    spot_extraction_subdir            = 'spots'
    spot_channels                     = ''
    spot_excluded_channels            = ''
    spot_scales                       = ''
    spot_subpaths                     = ''

    rsfish_min_intensity              = 0
    rsfish_max_intensity              = 4096
    rsfish_anisotropy                 = 0.7
    rsfish_sigma                      = 1.5
    rsfish_threshold                  = 0.007
    rsfish_background                 = 0
    rsfish_intensity                  = 0

    rsfish_spark_workers              = 1
    rsfish_min_spark_workers          = 1
    rsfish_spark_worker_cores         = 5
    rsfish_spark_gb_per_core          = 15
    rsfish_spark_driver_cores         = 1
    rsfish_spark_driver_mem_gb        = 0

    use_fishspots                     = false
    fishspots_psf_retries             = 3
    fishspots_intensity_threshold     = 0
    fishspots_config                  = "${projectDir}/conf/fishspots_config.yml"
    fishspots_dask_config             = "${projectDir}/conf/dask_config.yml"
    fishspots_blocksize               = '128,128,128'
    fishspots_dask_workers            = 1
    fishspots_min_dask_workers        = 1
    fishspots_dask_worker_cpus        = 1
    fishspots_dask_worker_mem_gb      = 4
    fishspots_local_workers           = 0
    fishspots_cpus                    = 1
    fishspots_mem_gb                  = 0
}

process {

    withName: "(.*)?SPOT_EXTRACTION:SPARK.*" {
        // set container for all spark tasks
        container = 'ghcr.io/janeliascicomp/rs-fish-spark:e1a45d0-omedev'
        errorStrategy = 'terminate'
    }

    withName: "(.*)?SPOT_EXTRACTION:RS_FISH" {
        errorStrategy = 'terminate'
        container = 'ghcr.io/janeliascicomp/rs-fish-spark:e1a45d0-omedev'
        ext.args = [
            optional_arg_value('--included-channels', params.spot_channels),
            optional_arg_value('--excluded-channels', params.spot_excluded_channels),
            arg_value('--minIntensity', params.rsfish_min_intensity),
            arg_value('--maxIntensity', params.rsfish_max_intensity),
            arg_value('--anisotropy', params.rsfish_anisotropy),
            arg_value('--sigma', params.rsfish_sigma),
            arg_value('--threshold', params.rsfish_threshold),
            arg_value('--background', params.rsfish_background),
        ].join(' ')
    }

    withName: "(.*)?SPOT_EXTRACTION:DASK.*" {
        // set container for all dask tasks
        container = 'ghcr.io/janeliascicomp/fishspots:0.5.0-ome-dask2025.5.1-py12-ol9'
        errorStrategy = 'terminate'
    }

    withName: "(.*)?SPOT_EXTRACTION:FISHSPOTS" {
        // set container for all dask tasks
        container = 'ghcr.io/janeliascicomp/fishspots:0.5.0-ome-dask2025.5.1-py12-ol9'
        errorStrategy = 'terminate'
        ext.args = [
            optional_arg_value('--blocksize', params.fishspots_blocksize),
            optional_arg_value('--included-channels', params.spot_channels),
            optional_arg_value('--excluded-channels', params.spot_excluded_channels),
            optional_arg_value('--psf-retries', params.fishspots_psf_retries),
            optional_arg_value('--intensity-threshold', params.fishspots_intensity_threshold),
            optional_arg_value('--local-dask-workers', params.fishspots_local_workers),
            optional_arg_value('--worker-cpus', params.fishspots_dask_worker_cpus),
        ].join(' ')
    }

    withName: "(.*)?SPOT_EXTRACTION:POST_RS_FISH" {
        container = 'ghcr.io/janeliascicomp/easifish-spots-utils:v1.1-ome'
        errorStrategy = 'terminate'
    }

}

def arg_value(arg_flag, arg_value) {
    "${arg_flag} ${arg_value}"
}

def bool_arg(arg_flag, arg_value) {
    arg_value ? "${arg_flag}" : ''
}

def optional_arg_value(arg_flag, arg_value) {
    arg_value ? "${arg_flag}=${arg_value}" : ''
}
