params {
    runtime_opts                      = ''

    spot_extraction_ids               = ''

    skip_spot_extraction              = false
    distributed_spot_extraction       = true
    spot_extraction_subdir            = 'spots'
    spot_channels                     = ''
    spot_excluded_channels            = ''
    spot_scales                       = ''
    spot_subpaths                     = ''

    rsfish_min_intensity              = '0'
    rsfish_max_intensity              = '4096'
    rsfish_anisotropy                 = '0.7'
    rsfish_sigma                      = '1.5'
    rsfish_threshold                  = '0.007'
    rsfish_background                 = '0'
    rsfish_intensity_th               = '0'
    rsfish_intensity_method           = '0'

    rsfish_spark_workers              = 1
    rsfish_min_spark_workers          = 1
    rsfish_spark_worker_cores         = 5
    rsfish_spark_gb_per_core          = 15
    rsfish_spark_driver_cores         = 1
    rsfish_spark_driver_mem_gb        = 0

    use_fishspots                     = false
    fishspots_psf_retries             = 3
    fishspots_intensity_threshold     = 0
    fishspots_config                  = "${projectDir}/conf/fishspots_config.yml"
    fishspots_dask_config             = "${projectDir}/conf/dask_config.yml"
    fishspots_blocksize               = '128,128,128'
    fishspots_dask_workers            = 1
    fishspots_min_dask_workers        = 1
    fishspots_dask_worker_cpus        = 1
    fishspots_dask_worker_mem_gb      = 4
    fishspots_local_workers           = 0
    fishspots_cpus                    = 1
    fishspots_mem_gb                  = 0
}

process {

    withName: "(.*)?SPOT_EXTRACTION:SPARK.*" {
        // set container for all spark tasks
        container = 'ghcr.io/janeliascicomp/rs-fish-spark:omedev'
        errorStrategy = 'terminate'
    }

    withName: "(.*)?SPOT_EXTRACTION:RS_FISH" {
        errorStrategy = 'terminate'
        container = 'ghcr.io/janeliascicomp/rs-fish-spark:omedev'
        ext.args = [
            optional_arg('--included-channels', params.spot_channels),
            optional_arg('--excluded-channels', params.spot_excluded_channels),
            rsfish_args(),
        ].join(' ')
    }

    withName: "(.*)?SPOT_EXTRACTION:DASK.*" {
        // set container for all dask tasks
        container = 'ghcr.io/janeliascicomp/fishspots:0.5.0-ome-dask2025.5.1-py12-ol9'
        errorStrategy = 'terminate'
    }

    withName: "(.*)?SPOT_EXTRACTION:FISHSPOTS" {
        // set container for all dask tasks
        container = 'ghcr.io/janeliascicomp/fishspots:0.5.0-ome-dask2025.5.1-py12-ol9'
        errorStrategy = 'terminate'
        ext.args = [
            optional_arg('--blocksize', params.fishspots_blocksize),
            optional_arg('--included-channels', params.spot_channels),
            optional_arg('--excluded-channels', params.spot_excluded_channels),
            optional_arg('--psf-retries', params.fishspots_psf_retries),
            optional_arg('--intensity-threshold', params.fishspots_intensity_threshold),
            optional_arg('--local-dask-workers', params.fishspots_local_workers),
            optional_arg('--worker-cpus', params.fishspots_dask_worker_cpus),
        ].join(' ')
    }

    withName: "(.*)?SPOT_EXTRACTION:POST_RS_FISH" {
        container = 'ghcr.io/janeliascicomp/easifish-spots-utils:v1.1-ome'
        errorStrategy = 'terminate'
    }

}

def rsfish_args() {
    // typically these parameters are numeric
    // if any is a string try to get a list of comma separated values
    min_intensity = params.rsfish_min_intensity.split(',')
    max_intensity = params.rsfish_max_intensity.split(',')
    anisotropy = params.rsfish_anisotropy.split(',')
    sigma = params.rsfish_sigma.split(',')
    threshold = params.rsfish_threshold.split(',')
    background = params.rsfish_background.split(',')
    intensityThreshold = params.rsfish_intensity_th.split(',')
    intensityMethod = params.rsfish_intensity_method.split(',')

    n_rsfish_args = [
        min_intensity.size(),
        max_intensity.size(),
        anisotropy.size(),
        sigma.size(),
        threshold.size(),
        background.size(),
        intensityThreshold.size(),
        intensityMethod.size(),
    ].max()

    def args = []
    for (int c = 0; c < n_rsfish_args; c++) {
        args << "--for-channel=${c-1}"
        if (c < min_intensity.size()) {
            args << "--minIntensity=${min_intensity[c]}"
        }
        if (c < max_intensity.size()) {
            args << "--maxIntensity=${max_intensity[c]}"
        }
        if (c < anisotropy.size()) {
            args << "--anisotropy=${anisotropy[c]}"
        }
        if (c < sigma.size()) {
            args << "--sigma=${sigma[c]}"
        }
        if (c < threshold.size()) {
            args << "--threshold=${threshold[c]}"
        }
        if (c < background.size()) {
            args << "--background=${background[c]}"
        }
        if (c < intensityThreshold.size()) {
            args << "--intensityThreshold=${intensityThreshold[c]}"
        }
        if (c < intensityMethod.size()) {
            args << "--intensityMethod=${intensityMethod[c]}"
        }
    }
    args.join(' ')
}

def optional_arg(arg_flag, arg_value) {
    arg_value ? "${arg_flag}=${arg_value}" : ''
}
