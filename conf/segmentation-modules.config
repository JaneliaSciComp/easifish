params {
    runtime_opts                       = ''

    segmentation_ids                   = 't1'
    segmentation_input                 = ''
    segmentation_subpaths              = ''
    seg_channels                       = ''
    seg_scales                         = 's2'
    segmentation_subdir                = 'segmentation'
    segmentation_imgname               = 'segmentation.n5'

    skip_segmentation                  = false
    distributed_cellpose               = true
    cellpose_model                     = 'cpsam'
    cellpose_models_dir                = ''
    cellpose_log_config                = "${projectDir}/conf/cellpose_logging_config.ini"
    cellpose_dask_config               = "${projectDir}/conf/dask_config.yml"

    sample_anisotropy                  = 1.0
    sample_expansion_factor            = 1.0
    sample_voxel_spacing               = ''
    sample_timeindex                   = ''
    sample_z_axis                      = 0
    sample_channel_axis                = ''

    distributed_cellpose_blocksize     = '128,128,128'
    cellpose_blocks_overlap            = ''
    cellpose_use_gpu                   = true
    cellpose_device                    = '0'

    cellpose_verbose                   = false
    cellpose_diameter                  = 30
    cellpose_min_size                  = 5
    cellpose_input_channels            = ''
    cellpose_norm_percentile           = ''
    cellpose_stitch_threshold          = 0.0
    cellprob_threshold                 = 1.0
    cellpose_flow3D_smooth             = 1
    cellpose_labels_distance_th        = 1.0

    cellpose_preprocessing_steps       = ''
    cellpose_preprocessing_params_file = ''

    cellpose_segmentation_cpus         = 1
    cellpose_segmentation_mem_gb       = 0

    cellpose_dask_workers              = 8
    cellpose_dask_min_workers          = 1
    cellpose_dask_worker_cpus          = 1
    cellpose_dask_worker_mem_gb        = 0

    cellpose_scheduler_port            = 0
    cellpose_dashboard_port            = 0

    cellpose_worker_runtime_opts       = ''
    cellpose_worker_cluster_opts       = ''
}

process {

    withName: "(.*):SEGMENTATION:(.*)" {
        container = 'ghcr.io/janeliascicomp/cellpose:4.0.6-dask2025.5.1-py12'
        containerOptions = params.runtime_opts
        errorStrategy = 'terminate'
    }

    withName: "(.*):SEGMENTATION:(.*)DASK_STARTMANAGER" {
        containerOptions = params.runtime_opts
        ext.args = [
            "--port ${params.cellpose_scheduler_port}",
            "--dashboard-address ${params.cellpose_dashboard_port}",
        ].join(' ')
    }

    withName: "(.*):SEGMENTATION:(.*)DASK_STARTWORKER" {
        containerOptions = "${params.runtime_opts} ${params.cellpose_worker_runtime_opts}"
        clusterOptions = "${params.cellpose_worker_cluster_opts}"
        ext.args = [
            "--nthreads ${params.cellpose_dask_worker_cpus}",
        ].join(' ')
    }

    withName: "(.*):SEGMENTATION:(.*)CELLPOSE" {
        time = 24.h
        ext.args = [
            optional_arg_value('--process-blocksize', params.distributed_cellpose_blocksize),
            optional_arg_value('--blocks-overlaps', params.cellpose_blocks_overlap),

            optional_arg_value('--model', params.cellpose_model),

            arg_value('--z_axis', params.sample_z_axis),
            arg_value('--channel_axis', params.sample_channel_axis),

            optional_arg_value('--anisotropy', params.sample_anisotropy),
            optional_arg_value('--expansion-factor', params.sample_expansion_factor),
            optional_arg_value('--voxel-spacing', params.sample_voxel_spacing),
            optional_arg_value('--timeindex', params.sample_timeindex),
            optional_arg_value('--input-channels', params.cellpose_input_channels),
            optional_arg_value('--norm_percentile', params.cellpose_norm_percentile),
            optional_arg_value('--stitch_threshold', params.cellpose_stitch_threshold),
            optional_arg_value('--cellprob_threshold', params.cellprob_threshold),
            optional_arg_value('--flow3D_smooth', params.cellpose_flow3D_smooth),
            optional_arg_value('--diam_mean', params.cellpose_diameter),
            optional_arg_value('--min_size', params.cellpose_min_size),
            optional_arg_value('--device', params.cellpose_device),
            optional_arg_value('--label-distance-threshold', params.cellpose_labels_distance_th),

            optional_arg_value('--preprocessing-steps', params.cellpose_preprocessing_steps),
            optional_arg_value('--preprocessing-config', params.cellpose_preprocessing_params_file),

            bool_arg('--use_gpu', params.cellpose_use_gpu),

            optional_arg_value('--local-dask-workers', params.cellpose_dask_workers),
            optional_arg_value('--worker-cpus', params.cellpose_dask_worker_cpus),

            bool_arg('--verbose', params.cellpose_verbose),
        ].join(' ')
    }

}

def arg_value(arg_flag, arg_value) {
    "${arg_flag} ${arg_value}"
}

def bool_arg(arg_flag, arg_value) {
    arg_value ? "${arg_flag}" : ''
}

def optional_arg_value(arg_flag, arg_value) {
    arg_value ? "${arg_flag} ${arg_value}" : ''
}
